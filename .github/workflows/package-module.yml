name: Package and Release Julian Clock Module

on:
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:
    # Allows manual triggering

jobs:
  update-version-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Explicitly grant permission to write to repository
      pull-requests: write  # Permission to update PR
    
    steps:
      - name: Determine workflow context
        id: context
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            if [ "${{ github.event.pull_request.merged }}" == "true" ]; then
              echo "is_pr_merge=true" >> $GITHUB_OUTPUT
              echo "is_pr_update=false" >> $GITHUB_OUTPUT
              echo "is_manual=false" >> $GITHUB_OUTPUT
              echo "Running in PR merge context"
            else
              echo "is_pr_merge=false" >> $GITHUB_OUTPUT
              echo "is_pr_update=false" >> $GITHUB_OUTPUT
              echo "is_manual=false" >> $GITHUB_OUTPUT
              echo "Running in PR update context (PR closed without merge)"
            fi
          else
            echo "is_pr_merge=false" >> $GITHUB_OUTPUT
            echo "is_pr_update=false" >> $GITHUB_OUTPUT
            echo "is_manual=true" >> $GITHUB_OUTPUT
            echo "Running in manual trigger context"
          fi

      - name: Check if repository is shallow
        id: check_shallow
        run: |
          if [ -f "$(git rev-parse --git-dir)/shallow" ]; then
            echo "is_shallow=true" >> $GITHUB_OUTPUT
          else
            echo "is_shallow=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Use fetch-depth: 0 for changelog generation when PR is merged or manual run
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}  # Needed for pushing changes
          # For PR merges, always use main branch; for PR updates use the PR branch; for manual runs use main
          ref: ${{ (steps.context.outputs.is_pr_merge == 'true' && 'main') || (steps.context.outputs.is_pr_update == 'true' && github.event.pull_request.head.ref) || 'main' }}
          # For PR updates, use the PR repository; otherwise use the current repository
          repository: ${{ (steps.context.outputs.is_pr_update == 'true' && github.event.pull_request.head.repo.full_name) || github.repository }}

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
      # Generate version for all contexts (PR update, PR merge, and manual run)
      - name: Generate version and dates
        id: set_version
        run: |
          # Generate base version from current date
          BASE_VERSION=$(date +'%Y.%m.%d')
          CREATION_DATE=$(date +'%Y %B %d')
          CURRENT_YEAR=$(date +'%Y')
          
          # Get all existing tags
          git fetch --tags
          
          # Check if the base version tag already exists
          if git rev-parse "$BASE_VERSION" >/dev/null 2>&1; then
            echo "Tag $BASE_VERSION already exists, finding next available version..."
            
            # Find all tags that match the pattern {BASE_VERSION}.{n}
            MATCHING_TAGS=$(git tag -l "$BASE_VERSION.*")
            
            if [ -z "$MATCHING_TAGS" ]; then
              # No sub-versions exist, use .1
              VERSION="${BASE_VERSION}.1"
            else
              # Find the highest sub-version
              HIGHEST_SUBVERSION=$(echo "$MATCHING_TAGS" | sed "s/^$BASE_VERSION\.//" | sort -n | tail -1)
              NEXT_SUBVERSION=$((HIGHEST_SUBVERSION + 1))
              VERSION="${BASE_VERSION}.$NEXT_SUBVERSION"
            fi
          else
            VERSION="$BASE_VERSION"
          fi
          
          echo "Generated version: $VERSION"
          echo "Creation date: $CREATION_DATE"
          echo "Current year: $CURRENT_YEAR"
          
          # Set outputs for use later
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "creation_date=$CREATION_DATE" >> $GITHUB_OUTPUT
          echo "current_year=$CURRENT_YEAR" >> $GITHUB_OUTPUT
      
      # Update files for all contexts
      - name: Update XML file in repository
        run: |
          # Find the XML file
          XML_FILE="mod_julianclock.xml"
          
          if [ -f "$XML_FILE" ]; then
            echo "Found XML file at: $XML_FILE"
            
            # Make a backup of the original file
            cp "$XML_FILE" "${XML_FILE}.bak"
            
            # Display original content
            echo "Original XML content (specific lines):"
            grep -A 6 "<creationDate>" "$XML_FILE" || true
            
            # Update version, creationDate, and copyright using sed with exact line matching
            sed -i "s|<version>.*</version>|<version>${{ steps.set_version.outputs.version }}</version>|g" "$XML_FILE"
            sed -i "s|<creationDate>.*</creationDate>|<creationDate>${{ steps.set_version.outputs.creation_date }}</creationDate>|g" "$XML_FILE"
            
            # Update copyright with year range if needed
            if [ "${{ steps.set_version.outputs.current_year }}" -gt "2025" ]; then
              sed -i "s|<copyright>Copyright (C)[0-9]\{4\} N6REJ</copyright>|<copyright>Copyright (C)2025 - ${{ steps.set_version.outputs.current_year }} N6REJ</copyright>|g" "$XML_FILE"
              sed -i "s|<copyright>Copyright (C)[0-9]\{4\} - [0-9]\{4\} N6REJ</copyright>|<copyright>Copyright (C)2025 - ${{ steps.set_version.outputs.current_year }} N6REJ</copyright>|g" "$XML_FILE"
            else
              sed -i "s|<copyright>Copyright (C)[0-9]\{4\} N6REJ</copyright>|<copyright>Copyright (C)${{ steps.set_version.outputs.current_year }} N6REJ</copyright>|g" "$XML_FILE"
            fi
            
            echo "Updated XML file in repository"
            echo "Updated XML content (specific lines):"
            grep -A 6 "<creationDate>" "$XML_FILE" || true
          else
            echo "::error::XML file not found in repository"
            exit 1
          fi
      
      - name: Update PHP file version
        run: |
          # Find PHP files and update version if they exist
          find . -name "*.php" | while read -r PHP_FILE; do
            if [ -f "$PHP_FILE" ]; then
              if grep -q "@version" "$PHP_FILE"; then
                echo "Updating version in PHP file: $PHP_FILE"
                # Updated regex to handle versions with .n suffixes and variable spacing
                sed -i -E "s|(@version[ ]+).*|\1${{ steps.set_version.outputs.version }}|g" "$PHP_FILE"
                sed -i -E "s|(Version[ ]*:[ ]*).*|\1${{ steps.set_version.outputs.version }}|g" "$PHP_FILE"
                # Update version pattern with asterisk format
                sed -i -E "s|(\* Version:)[0-9]{4}\.[0-9]{2}\.[0-9]{2}|\1${{ steps.set_version.outputs.version }}|g" "$PHP_FILE"
              fi
            fi
          done
      
      - name: Update version in all files
        run: |
          # Find all files and update any "* Version: YYYY.MM.DD" pattern
          find . -type f | while read -r FILE; do
            if [ -f "$FILE" ]; then
              if grep -q "\* Version:[0-9]\{4\}\.[0-9]\{2\}\.[0-9]\{2\}" "$FILE"; then
                echo "Updating version in file: $FILE"
                # Update the version pattern
                sed -i -E "s|(\* Version:)[0-9]{4}\.[0-9]{2}\.[0-9]{2}|\1${{ steps.set_version.outputs.version }}|g" "$FILE"
              fi
            fi
          done
      
      - name: Update existing language files
        run: |
          # Find language files and update copyright if they exist
          find . -name "*.ini" -o -name "*.sys.ini" | while read -r LANG_FILE; do
            if [ -f "$LANG_FILE" ]; then
              echo "Updating copyright in language file: $LANG_FILE"
              if [ "${{ steps.set_version.outputs.current_year }}" -gt "2025" ]; then
                sed -i "s|; Copyright (C) [0-9]\{4\} - [0-9]\{4\} N6REJ|; Copyright (C) 2025 - ${{ steps.set_version.outputs.current_year }} N6REJ|g" "$LANG_FILE"
                sed -i "s|; Copyright (C) [0-9]\{4\} N6REJ|; Copyright (C) 2025 - ${{ steps.set_version.outputs.current_year }} N6REJ|g" "$LANG_FILE"
              else
                sed -i "s|; Copyright (C) [0-9]\{4\} - [0-9]\{4\} N6REJ|; Copyright (C) ${{ steps.set_version.outputs.current_year }} N6REJ|g" "$LANG_FILE"
                sed -i "s|; Copyright (C) [0-9]\{4\} N6REJ|; Copyright (C) ${{ steps.set_version.outputs.current_year }} N6REJ|g" "$LANG_FILE"
              fi
            fi
          done
      
      - name: Update CSS file copyright and version
        run: |
          # Find CSS files and update copyright and version if they exist
          find . -name "*.css" | while read -r CSS_FILE; do
            if [ -f "$CSS_FILE" ]; then
              echo "Updating copyright and version in CSS file: $CSS_FILE"
              
              # Check if copyright header already exists
              if grep -q "Copyright (C)" "$CSS_FILE"; then
                # Update existing copyright with year range if needed
                if [ "${{ steps.set_version.outputs.current_year }}" -gt "2025" ]; then
                  sed -i "s|/\* Copyright (C) [0-9]\{4\} N6REJ \*/|/* Copyright (C) 2025 - ${{ steps.set_version.outputs.current_year }} N6REJ */|g" "$CSS_FILE"
                  sed -i "s|/\* Copyright (C) [0-9]\{4\} - [0-9]\{4\} N6REJ \*/|/* Copyright (C) 2025 - ${{ steps.set_version.outputs.current_year }} N6REJ */|g" "$CSS_FILE"
                  sed -i "s| \* Copyright (C) [0-9]\{4\} N6REJ| * Copyright (C) 2025 - ${{ steps.set_version.outputs.current_year }} N6REJ|g" "$CSS_FILE"
                  sed -i "s| \* Copyright (C) [0-9]\{4\} - [0-9]\{4\} N6REJ| * Copyright (C) 2025 - ${{ steps.set_version.outputs.current_year }} N6REJ|g" "$CSS_FILE"
                else
                  sed -i "s|/\* Copyright (C) [0-9]\{4\} N6REJ \*/|/* Copyright (C) ${{ steps.set_version.outputs.current_year }} N6REJ */|g" "$CSS_FILE"
                  sed -i "s|/\* Copyright (C) [0-9]\{4\} - [0-9]\{4\} N6REJ \*/|/* Copyright (C) ${{ steps.set_version.outputs.current_year }} N6REJ */|g" "$CSS_FILE"
                  sed -i "s| \* Copyright (C) [0-9]\{4\} N6REJ| * Copyright (C) ${{ steps.set_version.outputs.current_year }} N6REJ|g" "$CSS_FILE"
                  sed -i "s| \* Copyright (C) [0-9]\{4\} - [0-9]\{4\} N6REJ| * Copyright (C) ${{ steps.set_version.outputs.current_year }} N6REJ|g" "$CSS_FILE"
                fi
              fi
              
              # Update version if it exists in the format "* Version: YYYY.MM.DD"
              if grep -q "\* Version:[0-9]\{4\}\.[0-9]\{2\}\.[0-9]\{2\}" "$CSS_FILE"; then
                echo "Updating version pattern in CSS file: $CSS_FILE"
                sed -i -E "s|(\* Version:)[0-9]{4}\.[0-9]{2}\.[0-9]{2}|\1${{ steps.set_version.outputs.version }}|g" "$CSS_FILE"
              fi
            fi
          done
      
      # Generate changelog for PR merges or manual runs
      - name: Generate changelog
        if: steps.context.outputs.is_pr_merge == 'true' || steps.context.outputs.is_manual == 'true'
        id: changelog
        run: |
          # Find the previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 --always $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          
          # Get current date in ISO format
          CURRENT_DATE=$(date -u +"%Y-%m-%d")
          
          # Initialize categories
          ADDED=""
          CHANGED=""
          FIXED=""
          REMOVED=""
          SECURITY=""
          
          if [ -z "$PREVIOUS_TAG" ]; then
            # If no previous tag exists, use the first commit
            echo "No previous tag found, using all commits"
            COMMITS=$(git log --pretty=format:"%s|%h" --reverse)
          else
            echo "Previous tag: $PREVIOUS_TAG"
            # Get all commits since the previous tag
            COMMITS=$(git log --pretty=format:"%s|%h" ${PREVIOUS_TAG}..HEAD --reverse)
          fi
          
          # Process commits and categorize them
          while IFS= read -r line; do
            COMMIT_MSG=$(echo "$line" | cut -d'|' -f1)
            COMMIT_HASH=$(echo "$line" | cut -d'|' -f2)
            
            # Categorize based on commit message prefixes
            # You can adjust these patterns to match your commit style
            if [[ "$COMMIT_MSG" =~ ^(Add|Create|Implement|Feature) ]]; then
              ADDED="$ADDED\n* $COMMIT_MSG ([${COMMIT_HASH}](https://github.com/${{ github.repository }}/commit/${COMMIT_HASH}))"
            elif [[ "$COMMIT_MSG" =~ ^(Update|Improve|Enhance|Refactor|Change) ]]; then
              CHANGED="$CHANGED\n* $COMMIT_MSG ([${COMMIT_HASH}](https://github.com/${{ github.repository }}/commit/${COMMIT_HASH}))"
            elif [[ "$COMMIT_MSG" =~ ^(Fix|Bug|Correct|Resolve) ]]; then
              FIXED="$FIXED\n* $COMMIT_MSG ([${COMMIT_HASH}](https://github.com/${{ github.repository }}/commit/${COMMIT_HASH}))"
            elif [[ "$COMMIT_MSG" =~ ^(Remove|Delete|Deprecate) ]]; then
              REMOVED="$REMOVED\n* $COMMIT_MSG ([${COMMIT_HASH}](https://github.com/${{ github.repository }}/commit/${COMMIT_HASH}))"
            elif [[ "$COMMIT_MSG" =~ ^(Security) ]]; then
              SECURITY="$SECURITY\n* $COMMIT_MSG ([${COMMIT_HASH}](https://github.com/${{ github.repository }}/commit/${COMMIT_HASH}))"
            else
              # Default to Changed category if no pattern matches
              CHANGED="$CHANGED\n* $COMMIT_MSG ([${COMMIT_HASH}](https://github.com/${{ github.repository }}/commit/${COMMIT_HASH}))"
            fi
          done <<< "$COMMITS"
          
          # Create changelog file in Keep a Changelog format
          echo "# Changelog" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "All notable changes to this project will be documented in this file." >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/)," >> CHANGELOG.md
          echo "and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html)." >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          # Add current version section
          echo "## [${{ steps.set_version.outputs.version }}] - $CURRENT_DATE" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          # Add categorized changes
          if [ ! -z "$ADDED" ]; then
            echo "### Added" >> CHANGELOG.md
            echo -e "$ADDED" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          if [ ! -z "$CHANGED" ]; then
            echo "### Changed" >> CHANGELOG.md
            echo -e "$CHANGED" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          if [ ! -z "$FIXED" ]; then
            echo "### Fixed" >> CHANGELOG.md
            echo -e "$FIXED" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          if [ ! -z "$REMOVED" ]; then
            echo "### Removed" >> CHANGELOG.md
            echo -e "$REMOVED" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          if [ ! -z "$SECURITY" ]; then
            echo "### Security" >> CHANGELOG.md
            echo -e "$SECURITY" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          # If previous changelog exists, append it (skipping the header)
          if [ -f "CHANGELOG.md.bak" ]; then
            # Skip the first 7 lines of the backup (the standard header)
            tail -n +8 "CHANGELOG.md.bak" >> CHANGELOG.md
          fi
          
          # Save changelog to output for release notes
          CHANGELOG_OUTPUT=""
          if [ ! -z "$ADDED" ]; then
            CHANGELOG_OUTPUT="${CHANGELOG_OUTPUT}### Added\n${ADDED}\n\n"
          fi
          
          if [ ! -z "$CHANGED" ]; then
            CHANGELOG_OUTPUT="${CHANGELOG_OUTPUT}### Changed\n${CHANGED}\n\n"
          fi
          
          if [ ! -z "$FIXED" ]; then
            CHANGELOG_OUTPUT="${CHANGELOG_OUTPUT}### Fixed\n${FIXED}\n\n"
          fi
          
          if [ ! -z "$REMOVED" ]; then
            CHANGELOG_OUTPUT="${CHANGELOG_OUTPUT}### Removed\n${REMOVED}\n\n"
          fi
          
          if [ ! -z "$SECURITY" ]; then
            CHANGELOG_OUTPUT="${CHANGELOG_OUTPUT}### Security\n${SECURITY}\n\n"
          fi
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHANGELOG_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Display the generated changelog
          echo "Generated changelog:"
          cat CHANGELOG.md
      
      - name: Backup existing changelog
        if: steps.context.outputs.is_pr_merge == 'true' || steps.context.outputs.is_manual == 'true'
        run: |
          if [ -f "CHANGELOG.md" ]; then
            cp CHANGELOG.md CHANGELOG.md.bak
            echo "Backed up existing changelog"
          else
            echo "No existing changelog to backup"
          fi
      
      # For PR updates: Commit changes to PR branch
      - name: Commit changes to PR branch
        if: steps.context.outputs.is_pr_update == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Check if there are changes to commit
          if git diff --exit-code; then
            echo "No changes to commit"
          else
            git add .
            git commit -m "Update version to ${{ steps.set_version.outputs.version }}, creation date to ${{ steps.set_version.outputs.creation_date }}, and copyright year to ${{ steps.set_version.outputs.current_year }}"
            git push origin ${{ github.event.pull_request.head.ref }}
            echo "Changes committed and pushed to PR branch"
          fi
      
      # For PR merges: Commit changes to main branch
      - name: Commit changes to main branch for PR merge
        if: steps.context.outputs.is_pr_merge == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Check if there are changes to commit
          if git diff --exit-code; then
            echo "No changes to commit"
          else
            git add .
            git commit -m "Update version to ${{ steps.set_version.outputs.version }} for release"
            git push origin main
            echo "Changes committed and pushed to main branch"
          fi
      
      # For manual runs: Commit changes to main branch
      - name: Commit changes to main branch for manual run
        if: steps.context.outputs.is_manual == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Check if there are changes to commit
          if git diff --exit-code; then
            echo "No changes to commit"
          else
            git add .
            git commit -m "Update version to ${{ steps.set_version.outputs.version }}, creation date to ${{ steps.set_version.outputs.creation_date }}, and copyright year to ${{ steps.set_version.outputs.current_year }}"
            git push origin main
            echo "Changes committed and pushed to main branch"
          fi
      
      # For PR merges or manual runs: Create release
      - name: Create package directory
        if: steps.context.outputs.is_pr_merge == 'true' || steps.context.outputs.is_manual == 'true'
        run: mkdir -p package/mod_julianclock
      
      - name: Copy module files
        if: steps.context.outputs.is_pr_merge == 'true' || steps.context.outputs.is_manual == 'true'
        run: |
          # Copy required files
          cp mod_julianclock.php package/mod_julianclock/
          cp mod_julianclock.xml package/mod_julianclock/
          if [ -f "helper.php" ]; then
            cp helper.php package/mod_julianclock/
          fi
          
          # Copy optional files if they exist
          if [ -f "License.txt" ]; then
            cp License.txt package/mod_julianclock/
          fi
          
          if [ -f "index.html" ]; then
            cp index.html package/mod_julianclock/
          fi
          
          if [ -f "CHANGELOG.md" ]; then
            cp CHANGELOG.md package/mod_julianclock/
          fi
          
          # Copy directories
          if [ -d "css" ]; then
            cp -r css package/mod_julianclock/
          fi
          
          if [ -d "elements" ]; then
            cp -r elements package/mod_julianclock/
          fi
          
          if [ -d "tmpl" ]; then
            cp -r tmpl package/mod_julianclock/
          fi
          
          if [ -d "language" ]; then
            cp -r language package/mod_julianclock/
          fi
          
          # List the contents of the package directory
          echo "Package contents:"
          ls -la package/mod_julianclock/
      
      - name: Generate directory tree
        if: steps.context.outputs.is_pr_merge == 'true' || steps.context.outputs.is_manual == 'true'
        run: |
          apt-get update && apt-get install -y tree
          tree package/mod_julianclock > package/directory-structure.txt
      
      - name: Create ZIP archive
        if: steps.context.outputs.is_pr_merge == 'true' || steps.context.outputs.is_manual == 'true'
        run: |
          cd package
          zip -r mod_julianclock_${{ steps.set_version.outputs.version }}.zip mod_julianclock
          echo "Created ZIP archive: mod_julianclock_${{ steps.set_version.outputs.version }}.zip"
      
      
      - name: Create GitHub Release
        if: steps.context.outputs.is_pr_merge == 'true' || steps.context.outputs.is_manual == 'true'
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.set_version.outputs.version }}
          name: Julian Clock ${{ steps.set_version.outputs.version }}
          files: |
            package/mod_julianclock_${{ steps.set_version.outputs.version }}.zip
            package/directory-structure.txt
          draft: false
          prerelease: false
          body: |
            Julian Clock Module ${{ steps.set_version.outputs.version }}
            
            ### Download Options:
            - Download directly from this release page
            - Access the artifact from the Actions tab of this workflow run
            
            ## Changelog
            ${{ steps.changelog.outputs.changelog }}
            
            [View full changelog](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
      
      # Update the Joomla update server XML file after release is created
      - name: Update Joomla update server XML
        if: steps.context.outputs.is_pr_merge == 'true' || steps.context.outputs.is_manual == 'true'
        run: |
          # Define the updates.xml file path
          UPDATES_XML="updates.xml"
          
          if [ -f "$UPDATES_XML" ]; then
            echo "Found updates.xml file at: $UPDATES_XML"
            
            # Make a backup of the original file
            cp "$UPDATES_XML" "${UPDATES_XML}.bak"
            
            # Create the download URL for the new release
            DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.set_version.outputs.version }}/mod_julianclock_${{ steps.set_version.outputs.version }}.zip"
            
            # Update the version and download URL in the updates.xml file
            sed -i "s|<version>.*</version>|<version>${{ steps.set_version.outputs.version }}</version>|g" "$UPDATES_XML"
            sed -i "s|<downloadurl type=\"full\" format=\"zip\">.*</downloadurl>|<downloadurl type=\"full\" format=\"zip\">$DOWNLOAD_URL</downloadurl>|g" "$UPDATES_XML"
            
            echo "Updated updates.xml file with new version and download URL"
            echo "Updated XML content:"
            cat "$UPDATES_XML"
            
            # Commit and push the updated updates.xml file
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"
            
            # Check if there are changes to commit
            if git diff --exit-code; then
              echo "No changes to commit in updates.xml"
            else
              git add "$UPDATES_XML"
              git commit -m "Update updates.xml for version ${{ steps.set_version.outputs.version }}"
              git push origin main
              echo "Changes to updates.xml committed and pushed to main branch"
            fi
          else
            echo "::warning::updates.xml file not found in repository"
          fi
      
      # Upload artifact for easy access from GitHub Actions
      - name: Upload to GitHub Artifacts
        if: steps.context.outputs.is_pr_merge == 'true' || steps.context.outputs.is_manual == 'true'
        id: upload_artifact
        uses: actions/upload-artifact@v4.6.2
        with:
          name: mod_julianclock_${{ steps.set_version.outputs.version }}
          path: package/mod_julianclock_${{ steps.set_version.outputs.version }}.zip
          retention-days: 90
          if-no-files-found: warn
      
      # Add information about downloading the artifact
      - name: Artifact Download Information
        if: steps.context.outputs.is_pr_merge == 'true' || steps.context.outputs.is_manual == 'true'
        run: |
          echo "::notice::The module package has been uploaded as an artifact."
          echo "::notice::You can download it from the Actions tab of this workflow run."
          echo "::notice::Go to Actions → This workflow → This run → Artifacts section → Download 'mod_julianclock_${{ steps.set_version.outputs.version }}'"
